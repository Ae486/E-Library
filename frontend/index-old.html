<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯ä¹¦èˆ - ä¸»é¡µ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="logo">ğŸ“š äº‘ç«¯ä¹¦èˆ</div>
            <div class="nav-links">
                <a href="index.html">å›¾ä¹¦æ£€ç´¢</a>
                <a href="#" onclick="showMyBorrowings()">æˆ‘çš„å€Ÿé˜…</a>
                <a href="#" onclick="showAdminPanel()" id="admin-link" style="display: none;">ç®¡ç†é¢æ¿</a>
                <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
            </div>
            <div class="user-info">
                æ¬¢è¿ï¼Œ<span id="username"></span>
            </div>
        </div>

        <div id="alert" style="display: none;"></div>

        <!-- å›¾ä¹¦æ£€ç´¢åŒºåŸŸ -->
        <div id="book-search-area">
            <h2 style="margin-bottom: 20px; color: #333;">å›¾ä¹¦æ£€ç´¢</h2>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢ä¹¦åã€ä½œè€…æˆ–ISBN...">
                <button class="btn btn-primary" onclick="searchBooks()">æœç´¢</button>
                <button class="btn btn-secondary" onclick="loadAllBooks()">æ˜¾ç¤ºå…¨éƒ¨</button>
            </div>

            <div id="books-container" class="grid"></div>
        </div>

        <!-- æˆ‘çš„å€Ÿé˜…è®°å½•åŒºåŸŸ -->
        <div id="my-borrowings-area" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #333;">æˆ‘çš„å€Ÿé˜…è®°å½•</h2>
            <button class="btn btn-secondary" onclick="showBookSearch()" style="margin-bottom: 20px;">è¿”å›å›¾ä¹¦æ£€ç´¢</button>
            <div id="borrowings-container"></div>
        </div>

        <!-- ç®¡ç†å‘˜é¢æ¿ -->
        <div id="admin-area" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #333;">ç®¡ç†å‘˜é¢æ¿</h2>
            <button class="btn btn-secondary" onclick="showBookSearch()" style="margin-bottom: 20px;">è¿”å›ä¸»é¡µ</button>

            <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <h3 id="total-users">0</h3>
                    <p>æ€»ç”¨æˆ·æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-books">0</h3>
                    <p>æ€»å›¾ä¹¦æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-borrowings">0</h3>
                    <p>å€Ÿé˜…æ¬¡æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="current-borrowings">0</h3>
                    <p>å½“å‰å€Ÿé˜…</p>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">æ·»åŠ æ–°å›¾ä¹¦</h3>
                <form onsubmit="addBook(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>ä¹¦å</label>
                        <input type="text" id="book-title" required>
                    </div>
                    <div class="form-group">
                        <label>ä½œè€…</label>
                        <input type="text" id="book-author" required>
                    </div>
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" id="book-isbn">
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <input type="text" id="book-category">
                    </div>
                    <div class="form-group">
                        <label>å‡ºç‰ˆç¤¾</label>
                        <input type="text" id="book-publisher">
                    </div>
                    <div class="form-group">
                        <label>æ•°é‡</label>
                        <input type="number" id="book-quantity" value="1" min="1">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ç®€ä»‹</label>
                        <textarea id="book-description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" style="grid-column: 1 / -1;">æ·»åŠ å›¾ä¹¦</button>
                </form>
            </div>

            <div>
                <h3 style="color: #333; margin-bottom: 15px;">æ‰€æœ‰å›¾ä¹¦åˆ—è¡¨</h3>
                <div id="admin-books-container"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            document.getElementById('username').textContent = currentUser.username;

            if (currentUser.role === 'admin') {
                document.getElementById('admin-link').style.display = 'block';
            }

            loadAllBooks();
        };

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function showBookSearch() {
            document.getElementById('book-search-area').style.display = 'block';
            document.getElementById('my-borrowings-area').style.display = 'none';
            document.getElementById('admin-area').style.display = 'none';
        }

        function showMyBorrowings() {
            document.getElementById('book-search-area').style.display = 'none';
            document.getElementById('my-borrowings-area').style.display = 'block';
            document.getElementById('admin-area').style.display = 'none';
            loadMyBorrowings();
        }

        function showAdminPanel() {
            if (currentUser.role !== 'admin') {
                showAlert('æƒé™ä¸è¶³', 'error');
                return;
            }
            document.getElementById('book-search-area').style.display = 'none';
            document.getElementById('my-borrowings-area').style.display = 'none';
            document.getElementById('admin-area').style.display = 'block';
            loadAdminData();
        }

        async function loadAllBooks() {
            try {
                const response = await fetch(`${API_BASE}/books/list`);
                const data = await response.json();

                if (data.success) {
                    displayBooks(data.books);
                }
            } catch (error) {
                showAlert('åŠ è½½å›¾ä¹¦å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        async function searchBooks() {
            const query = document.getElementById('search-input').value;
            try {
                const response = await fetch(`${API_BASE}/books/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success) {
                    displayBooks(data.books);
                }
            } catch (error) {
                showAlert('æœç´¢å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        function displayBooks(books) {
            const container = document.getElementById('books-container');
            if (books.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœªæ‰¾åˆ°ç›¸å…³å›¾ä¹¦</p>';
                return;
            }

            container.innerHTML = books.map(book => `
                <div class="card">
                    <div class="card-title">${book.title}</div>
                    <div class="card-content">
                        <p><strong>ä½œè€…:</strong> ${book.author || 'æœªçŸ¥'}</p>
                        <p><strong>åˆ†ç±»:</strong> ${book.category || 'æœªåˆ†ç±»'}</p>
                        <p><strong>å‡ºç‰ˆç¤¾:</strong> ${book.publisher || 'æœªçŸ¥'}</p>
                        <p><strong>ISBN:</strong> ${book.isbn || 'æ— '}</p>
                        <p><strong>åº“å­˜:</strong> ${book.available_quantity} / ${book.total_quantity}</p>
                        <p style="margin-top: 10px; color: #666;">${book.description || 'æš‚æ— ç®€ä»‹'}</p>
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;"
                                onclick="borrowBook(${book.id})"
                                ${book.available_quantity <= 0 ? 'disabled' : ''}>
                            ${book.available_quantity > 0 ? 'å€Ÿé˜…' : 'åº“å­˜ä¸è¶³'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function borrowBook(bookId) {
            if (!confirm('ç¡®è®¤å€Ÿé˜…æ­¤å›¾ä¹¦ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/books/borrow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id, book_id: bookId })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('å€Ÿé˜…æˆåŠŸï¼', 'success');
                    loadAllBooks();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('å€Ÿé˜…å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        async function loadMyBorrowings() {
            try {
                const response = await fetch(`${API_BASE}/books/my-borrowings/${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    displayBorrowings(data.records);
                }
            } catch (error) {
                showAlert('åŠ è½½å€Ÿé˜…è®°å½•å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        function displayBorrowings(records) {
            const container = document.getElementById('borrowings-container');
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å€Ÿé˜…è®°å½•</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ä¹¦å</th>
                            <th>ä½œè€…</th>
                            <th>å€Ÿé˜…æ—¥æœŸ</th>
                            <th>åˆ°æœŸæ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td>${record.title}</td>
                                <td>${record.author}</td>
                                <td>${new Date(record.borrow_date).toLocaleDateString()}</td>
                                <td>${new Date(record.due_date).toLocaleDateString()}</td>
                                <td>
                                    <span class="badge badge-${record.status === 'borrowed' ? 'warning' : 'success'}">
                                        ${record.status === 'borrowed' ? 'å€Ÿé˜…ä¸­' : 'å·²å½’è¿˜'}
                                    </span>
                                </td>
                                <td>
                                    ${record.status === 'borrowed' ? `
                                        <button class="btn btn-success" style="padding: 6px 12px; margin-right: 5px;"
                                                onclick="returnBook(${record.id})">å½’è¿˜</button>
                                        <button class="btn btn-secondary" style="padding: 6px 12px;"
                                                onclick="renewBook(${record.id})">ç»­å€Ÿ</button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function returnBook(recordId) {
            if (!confirm('ç¡®è®¤å½’è¿˜æ­¤å›¾ä¹¦ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/books/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('å½’è¿˜æˆåŠŸï¼', 'success');
                    loadMyBorrowings();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('å½’è¿˜å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        async function renewBook(recordId) {
            if (!confirm('ç¡®è®¤ç»­å€Ÿæ­¤å›¾ä¹¦ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/books/renew`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('ç»­å€ŸæˆåŠŸï¼', 'success');
                    loadMyBorrowings();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('ç»­å€Ÿå¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        async function loadAdminData() {
            try {
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const statsResponse = await fetch(`${API_BASE}/admin/borrowings/statistics`);
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    document.getElementById('total-borrowings').textContent = statsData.total_borrowings;
                    document.getElementById('current-borrowings').textContent = statsData.current_borrowings;
                }

                const userStatsResponse = await fetch(`${API_BASE}/admin/users/statistics`);
                const userStatsData = await userStatsResponse.json();

                if (userStatsData.success) {
                    document.getElementById('total-users').textContent = userStatsData.total_users;
                }

                // åŠ è½½å›¾ä¹¦åˆ—è¡¨
                const booksResponse = await fetch(`${API_BASE}/books/list`);
                const booksData = await booksResponse.json();

                if (booksData.success) {
                    document.getElementById('total-books').textContent = booksData.books.length;
                    displayAdminBooks(booksData.books);
                }
            } catch (error) {
                showAlert('åŠ è½½ç®¡ç†æ•°æ®å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        function displayAdminBooks(books) {
            const container = document.getElementById('admin-books-container');
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ä¹¦å</th>
                            <th>ä½œè€…</th>
                            <th>åˆ†ç±»</th>
                            <th>åº“å­˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${books.map(book => `
                            <tr>
                                <td>${book.title}</td>
                                <td>${book.author}</td>
                                <td>${book.category || '-'}</td>
                                <td>${book.available_quantity} / ${book.total_quantity}</td>
                                <td>
                                    <button class="btn btn-danger" style="padding: 6px 12px;"
                                            onclick="deleteBook(${book.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function addBook(event) {
            event.preventDefault();

            const bookData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                isbn: document.getElementById('book-isbn').value,
                category: document.getElementById('book-category').value,
                publisher: document.getElementById('book-publisher').value,
                total_quantity: parseInt(document.getElementById('book-quantity').value),
                description: document.getElementById('book-description').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/books/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('æ·»åŠ æˆåŠŸï¼', 'success');
                    event.target.reset();
                    loadAdminData();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('æ·»åŠ å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }

        async function deleteBook(bookId) {
            if (!confirm('ç¡®è®¤åˆ é™¤æ­¤å›¾ä¹¦ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/books/delete/${bookId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                    loadAdminData();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥', 'error');
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>